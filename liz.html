<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Astronomical Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000;
            color: #e0e6ed;
            overflow-x: hidden;
        }
        #galaxy-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }
        #welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            transition: opacity 1s ease;
        }
        .welcome-content {
            text-align: center;
            max-width: 600px;
            padding: 40px;
            background: rgba(15, 15, 35, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(79, 172, 254, 0.3);
            box-shadow: 0 20px 60px rgba(79, 172, 254, 0.2);
        }
        .welcome-title {
            font-size: 3rem;
            background: linear-gradient(45deg, #4facfe, #00f2fe, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            animation: glow 2s ease-in-out infinite alternate;
        }
        @keyframes glow {
            from { filter: drop-shadow(0 0 20px rgba(79, 172, 254, 0.5)); }
            to { filter: drop-shadow(0 0 30px rgba(79, 172, 254, 0.8)); }
        }
        .welcome-subtitle {
            font-size: 1.3rem;
            color: #b0b6c3;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        .explore-btn {
            padding: 15px 40px;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            border: none;
            border-radius: 50px;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .explore-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 15px 35px rgba(79, 172, 254, 0.4);
        }
        .floating-instruction {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 15, 35, 0.9);
            padding: 15px 25px;
            border-radius: 25px;
            border: 1px solid rgba(79, 172, 254, 0.3);
            z-index: 5;
            animation: float 3s ease-in-out infinite;
            opacity: 0;
            transition: opacity 1s ease;
        }
        @keyframes float {
            0%, 100% { transform: translateX(-50%) translateY(0px); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }
        .calculator-container {
            position: relative;
            z-index: 15;
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 50px;
            margin-bottom: 50px;
            display: none;
        }
        .calculator-container.visible {
            display: block;
            animation: slideUp 1s ease;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        .back-btn {
            position: fixed;
            top: 30px;
            left: 30px;
            padding: 12px 20px;
            background: rgba(79, 172, 254, 0.2);
            border: 1px solid rgba(79, 172, 254, 0.5);
            border-radius: 25px;
            color: #4facfe;
            cursor: pointer;
            z-index: 20;
            transition: all 0.3s ease;
            display: none;
            font-weight: 600;
        }
        .back-btn:hover {
            background: rgba(79, 172, 254, 0.3);
            transform: translateX(-5px);
        }
        .info-overlay {
            position: fixed;
            top: 30px;
            right: 30px;
            background: rgba(15, 15, 35, 0.8);
            color: #e0e6ed;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 25;
            opacity: 0;
            transition: opacity 0.5s ease, transform 0.5s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(79, 172, 254, 0.2);
            pointer-events: none;
            display: none;
        }
         .distance-display {
            position: fixed;
            bottom: 30px;
            right: 30px;
            text-align: right;
            color: #fff;
            z-index: 5;
            font-size: 1.2rem;
            background: rgba(15, 15, 35, 0.8);
            padding: 15px 25px;
            border-radius: 10px;
            border: 1px solid rgba(79, 172, 254, 0.2);
            backdrop-filter: blur(10px);
            opacity: 0;
            transition: opacity 0.8s ease;
            pointer-events: none;
        }
        .distance-display strong {
            font-size: 1.5rem;
            display: block;
            color: #4facfe;
        }
        .form-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .section-title {
            font-size: 1.3rem;
            color: #4facfe;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .location-options {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        .option-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .option-card:hover {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.1);
            transform: translateY(-2px);
        }
        .option-card.selected {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.15);
        }
        .planet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .planet-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        .planet-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(79, 172, 254, 0.2), transparent);
            transition: left 0.5s ease;
        }
        .planet-card:hover::before {
            left: 100%;
        }
        .planet-card:hover {
            border-color: #4facfe;
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.3);
        }
        .planet-card.selected {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.15);
            transform: scale(1.02);
        }
        .planet-visual {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
            position: relative;
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.3);
        }
        .mercury { background: radial-gradient(circle at 30% 30%, #8c7853, #5c5c5c); }
        .venus { background: radial-gradient(circle at 30% 30%, #ffc649, #ff8c00); }
        .mars { background: radial-gradient(circle at 30% 30%, #cd5c5c, #8b0000); }
        .jupiter { background: radial-gradient(circle at 30% 30%, #d2691e, #8b4513); }
        .saturn { background: radial-gradient(circle at 30% 30%, #fad5a5, #deb887); }
        .uranus { background: radial-gradient(circle at 30% 30%, #4fd0e3, #00ced1); }
        .neptune { background: radial-gradient(circle at 30% 30%, #4169e1, #191970); }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #b0b6c3;
            font-weight: 500;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #e0e6ed;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .input-group input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
            background: rgba(255, 255, 255, 0.08);
        }
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .calculate-btn, .lookup-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(45deg, #4facfe, #00f2fe);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .lookup-btn {
            font-size: 0.9rem;
            padding: 10px 20px;
            margin-top: 10px;
        }
        .calculate-btn:hover, .lookup-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(79, 172, 254, 0.4);
        }
        .results {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-label {
            color: #b0b6c3;
            font-weight: 500;
        }
        .result-value {
            color: #4facfe;
            font-weight: 600;
        }
        .ai-insight {
            background: linear-gradient(45deg, rgba(79, 172, 254, 0.1), rgba(0, 242, 254, 0.1));
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #4facfe;
        }
        .error {
            background: rgba(255, 79, 79, 0.1);
            border-left: 4px solid #ff4f4f;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #ffb3b3;
        }
        .loading {
            color: #4facfe;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }
        @media (max-width: 768px) {
            .calculator-container { padding: 20px; margin: 20px; }
            .header h1 { font-size: 2rem; }
            .planet-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; }
            .input-row { grid-template-columns: 1fr; }
            .welcome-title { font-size: 2.2rem; }
            .info-overlay, .distance-display { display: none !important; } /* Hide complex overlays on mobile */
        }
    </style>
</head>
<body>
    <div id="galaxy-container"></div>

    <div id="welcome-overlay">
        <div class="welcome-content">
            <h1 class="welcome-title">Universal Astronomical Calculator</h1>
            <p class="welcome-subtitle">
                Explore a dynamic galaxy, select a planet, and calculate its precise position from your location on Earth.
            </p>
            <button class="explore-btn" onclick="startExploration()">
                Begin Cosmic Journey
            </button>
        </div>
    </div>
    
    <div class="floating-instruction" id="galaxy-instructions">
        Move your mouse to explore the galaxy - Click anywhere to access the calculator
    </div>

    <button class="back-btn" id="back-btn" onclick="returnToGalaxy()">
        ← Back to Galaxy
    </button>
    
    <div class="info-overlay" id="info-overlay">
        <p><strong style="color: #4facfe;">Location:</strong> <span id="overlay-location"></span></p>
        <p><strong style="color: #4facfe;">Date/Time (UTC):</strong> <span id="overlay-datetime"></span></p>
    </div>

    <div class="distance-display" id="distance-display"></div>

    <div class="calculator-container" id="calculator">
        <div class="header">
            <h1>Planetary Position Calculator</h1>
            <p>Calculate precise planetary positions from your observation point</p>
        </div>
        <div class="form-section">
            <h3 class="section-title">Choose Your Observation Location</h3>
            <div class="location-options">
                <div class="option-card" onclick="selectLocationOption('coordinates', this)">
                    <h4>Precise Coordinates</h4>
                    <p>Enter exact latitude and longitude</p>
                </div>
                <div class="option-card" onclick="selectLocationOption('city', this)">
                    <h4>City Name</h4>
                    <p>Search by city or location name</p>
                </div>
                <div class="option-card selected" onclick="selectLocationOption('default', this)">
                    <h4>Default Location</h4>
                    <p>Smoky Hill High School, Aurora, CO</p>
                </div>
            </div>
            <div id="coordinates-input" class="input-section" style="display: none;">
                <div class="input-row">
                    <div class="input-group">
                        <label for="latitude">Latitude</label>
                        <input type="number" id="latitude" placeholder="e.g., 40.7128" step="any">
                    </div>
                    <div class="input-group">
                        <label for="longitude">Longitude</label>
                        <input type="number" id="longitude" placeholder="e.g., -74.0060" step="any">
                    </div>
                </div>
            </div>
            <div id="city-input" class="input-section" style="display: none;">
                <div class="input-group">
                    <label for="city">City Name</label>
                    <input type="text" id="city" placeholder="e.g., London, Tokyo, New York">
                    <button class="lookup-btn" onclick="lookupCity()">Lookup Coordinates</button>
                </div>
                <div id="city-result"></div>
            </div>
        </div>
        <div class="form-section">
            <h3 class="section-title">Select Planet</h3>
            <div class="planet-grid">
                <div class="planet-card" onclick="selectPlanet('Mercury', this)">
                    <div class="planet-visual mercury"></div>
                    <div><strong>Mercury</strong></div>
                    <small>Closest to Sun</small>
                </div>
                <div class="planet-card" onclick="selectPlanet('Venus', this)">
                    <div class="planet-visual venus"></div>
                    <div><strong>Venus</strong></div>
                    <small>Brightest Planet</small>
                </div>
                <div class="planet-card" onclick="selectPlanet('Mars', this)">
                    <div class="planet-visual mars"></div>
                    <div><strong>Mars</strong></div>
                    <small>The Red Planet</small>
                </div>
                <div class="planet-card" onclick="selectPlanet('Jupiter', this)">
                    <div class="planet-visual jupiter"></div>
                    <div><strong>Jupiter</strong></div>
                    <small>Gas Giant</small>
                </div>
                <div class="planet-card" onclick="selectPlanet('Saturn', this)">
                    <div class="planet-visual saturn"></div>
                    <div><strong>Saturn</strong></div>
                    <small>Ringed Planet</small>
                </div>
                <div class="planet-card" onclick="selectPlanet('Uranus', this)">
                    <div class="planet-visual uranus"></div>
                    <div><strong>Uranus</strong></div>
                    <small>Ice Giant</small>
                </div>
                <div class="planet-card" onclick="selectPlanet('Neptune', this)">
                    <div class="planet-visual neptune"></div>
                    <div><strong>Neptune</strong></div>
                    <small>Windiest Planet</small>
                </div>
            </div>
        </div>
        <div class="form-section">
            <h3 class="section-title">Date and Time</h3>
            <div class="input-row">
                <div class="input-group">
                    <label for="date">Date</label>
                    <input type="date" id="date">
                </div>
                <div class="input-group">
                    <label for="time">Time (24-hour format)</label>
                    <input type="time" id="time" step="1">
                </div>
            </div>
        </div>
        <button class="calculate-btn" onclick="calculatePosition()">
            Calculate Planet Position
        </button>
        <div id="results" style="display: none;">
            <div class="results">
                <h3 class="section-title">Calculation Results</h3>
                <div id="position-details"></div>
                <div id="ai-insight" class="ai-insight"></div>
            </div>
        </div>
    </div>

    <script>
        let scene, camera, renderer, galaxyGroup, stars, planetMesh = null;
        let selectedLocation = 'default';
        let selectedPlanet = null;
        let locationData = {
            latitude: 39.6411,
            longitude: -104.7574,
            name: "Smoky Hill High School, Aurora, CO"
        };
        const planetColors = { // For 3D models
            'Mercury': 0x8c7853,
            'Venus': 0xffc649,
            'Mars': 0xcd5c5c,
            'Jupiter': 0xd2691e,
            'Saturn': 0xfad5a5,
            'Uranus': 0x4fd0e3,
            'Neptune': 0x4169e1
        };

        const now = new Date();
        document.getElementById('date').value = now.toISOString().split('T')[0];
        document.getElementById('time').value = now.toTimeString().split(' ')[0].substring(0, 8);

        window.addEventListener('load', initGalaxy);
        window.addEventListener('resize', onWindowResize);

        function initGalaxy() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000);
            document.getElementById('galaxy-container').appendChild(renderer.domElement);

            galaxyGroup = new THREE.Group();
            scene.add(galaxyGroup);

            createSpiralGalaxy();
            createStarField();

            camera.position.z = 50;

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.1);
            scene.add(ambientLight);

            const pointLight = new THREE.PointLight(0xfff5e1, 1.5, 300);
            scene.add(pointLight);

            setupMouseInteraction();
            animate();
        }

        function createSpiralGalaxy() {
            const positions = [];
            const colors = [];
            const numStars = 20000;

            for (let i = 0; i < numStars; i++) {
                const angle = i * 0.01;
                const radius = Math.pow(i / numStars, 0.6) * 40;
                const spiralAngle = angle * 3 + radius * 0.2;
                
                const randomRadius = Math.pow(Math.random(), 2);

                const x = Math.cos(spiralAngle) * radius + (Math.random() - 0.5) * randomRadius * 8;
                const z = Math.sin(spiralAngle) * radius + (Math.random() - 0.5) * randomRadius * 8;
                const y = (Math.random() - 0.5) * 5 * randomRadius;

                positions.push(x, y, z);

                const colorIntensity = 1 - (radius / 40);
                const colorBias = Math.random() * 0.2 - 0.1; // -0.1 to +0.1
                colors.push(
                    Math.max(0.1, 0.3 + colorIntensity * 0.7 + colorBias * 0.5), // R
                    Math.max(0.1, 0.6 + colorIntensity * 0.4),                   // G
                    Math.max(0.1, 1.0 - colorBias * 0.5)                        // B
                );
            }
            
            const galaxyGeometry = new THREE.BufferGeometry();
            galaxyGeometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            galaxyGeometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            
            const galaxyMaterial = new THREE.PointsMaterial({
                size: 0.3,
                sizeAttenuation: true,
                transparent: true,
                opacity: 0.8,
                vertexColors: true
            });
            const galaxy = new THREE.Points(galaxyGeometry, galaxyMaterial);
            galaxyGroup.add(galaxy);
        }

        function createStarField() {
            const starPositions = [];
            for (let i = 0; i < 5000; i++) {
                starPositions.push(
                    (Math.random() - 0.5) * 500,
                    (Math.random() - 0.5) * 500,
                    (Math.random() - 0.5) * 500
                );
            }
            const starGeometry = new THREE.BufferGeometry();
            starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starPositions, 3));
            const starMaterial = new THREE.PointsMaterial({
                color: 0xffffff,
                size: 0.2,
                transparent: true,
                opacity: 0.6
            });
            stars = new THREE.Points(starGeometry, starMaterial);
            scene.add(stars);
        }

        function setupMouseInteraction() {
             let mouseX = 0, mouseY = 0;
            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
            });
            document.addEventListener('click', (event) => {
                if(event.target.closest('.calculator-container') || event.target.closest('.explore-btn')) return;
                if (document.getElementById('welcome-overlay').style.display !== 'none') return;
                if (document.getElementById('calculator').classList.contains('visible')) return;
                showCalculator();
            });

            function updateCamera() {
                if (!document.getElementById('calculator').classList.contains('visible')) {
                    const targetX = mouseX * 20;
                    const targetY = mouseY * 20;
                    camera.position.x += (targetX - camera.position.x) * 0.05;
                    camera.position.y += (targetY - camera.position.y) * 0.05;
                    camera.lookAt(scene.position);
                }
                requestAnimationFrame(updateCamera);
            }
            updateCamera();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            galaxyGroup.rotation.y += 0.0005;
            stars.rotation.y += 0.0001;

            if (stars) { // Twinkle effect
                const positions = stars.geometry.attributes.position.array;
                const time = Date.now() * 0.00005;
                for (let i = 0; i < positions.length; i += 3) {
                    const randomFactor = Math.sin(i + time);
                    positions[i+1] += randomFactor * 0.001;
                }
                stars.geometry.attributes.position.needsUpdate = true;
            }
            if (planetMesh) {
                planetMesh.rotation.y += 0.005;
            }
            renderer.render(scene, camera);
        }

        function startExploration() {
            document.getElementById('welcome-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('welcome-overlay').style.display = 'none';
                document.getElementById('galaxy-instructions').style.opacity = '1';
            }, 1000);
        }

        function showCalculator() {
            document.getElementById('galaxy-instructions').style.opacity = '0';
            const calculator = document.getElementById('calculator');
            calculator.style.display = 'block';
            setTimeout(() => calculator.classList.add('visible'), 10);
            document.getElementById('back-btn').style.display = 'block';
            document.body.style.overflow = 'auto';

            // Update and show info overlay
            const infoOverlay = document.getElementById('info-overlay');
            document.getElementById('overlay-location').textContent = locationData.name;
            const dateStr = document.getElementById('date').value;
            const timeStr = document.getElementById('time').value;
            const obsDate = new Date(`${dateStr}T${timeStr}Z`);
            document.getElementById('overlay-datetime').textContent = obsDate.toUTCString().replace("GMT", "");
            infoOverlay.style.display = 'block';
            setTimeout(() => infoOverlay.style.opacity = '1', 10);
        }

        function returnToGalaxy() {
            document.getElementById('calculator').classList.remove('visible');
            document.getElementById('back-btn').style.display = 'none';
            document.getElementById('galaxy-instructions').style.opacity = '1';
            document.body.style.overflow = 'hidden';

            const infoOverlay = document.getElementById('info-overlay');
            infoOverlay.style.opacity = '0';
            document.getElementById('distance-display').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('calculator').style.display = 'none';
                infoOverlay.style.display = 'none';
            }, 1000);
        }

        function selectPlanet(planet, element) {
            selectedPlanet = planet;
            document.querySelectorAll('.planet-grid .planet-card').forEach(card => card.classList.remove('selected'));
            element.classList.add('selected');

            // --- 3D Planet Preview Logic ---
            if (planetMesh) {
                scene.remove(planetMesh);
                planetMesh.geometry.dispose();
                planetMesh.material.dispose();
                planetMesh = null;
            }

            const geometry = new THREE.SphereGeometry(3, 32, 32);
            const material = new THREE.MeshStandardMaterial({
                color: planetColors[planet],
                emissive: planetColors[planet],
                emissiveIntensity: 0.2
            });
            planetMesh = new THREE.Mesh(geometry, material);
            planetMesh.position.set(-15, 5, 20);
            scene.add(planetMesh);
            
            // Hide distance display until calculation
            document.getElementById('distance-display').style.opacity = '0';
        }

        function selectLocationOption(option, element) { /* ... no changes ... */
            selectedLocation = option;
            document.querySelectorAll('.location-options .option-card').forEach(card => {
                card.classList.remove('selected');
            });
            element.classList.add('selected');

            document.getElementById('coordinates-input').style.display = option === 'coordinates' ? 'block' : 'none';
            document.getElementById('city-input').style.display = option === 'city' ? 'block' : 'none';

            if (option === 'default') {
                locationData = {
                    latitude: 39.6411,
                    longitude: -104.7574,
                    name: "Smoky Hill High School, Aurora, CO"
                };
                document.getElementById('city-result').innerHTML = '';
            }
        }
        
        async function lookupCity() { /* ... no changes ... */
            const cityName = document.getElementById('city').value.trim();
            const resultDiv = document.getElementById('city-result');

            if (!cityName) {
                resultDiv.innerHTML = '<div class="error">Please enter a city name.</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="loading">Looking up coordinates...</div>';

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cityName)}&limit=1`);
                const data = await response.json();

                if (data.length > 0) {
                    const location = data[0];
                    locationData = {
                        latitude: parseFloat(location.lat),
                        longitude: parseFloat(location.lon),
                        name: location.display_name
                    };
                    resultDiv.innerHTML = `<div style="color: #4facfe; margin-top: 10px;">Found: ${location.display_name}</div>`;
                } else {
                    resultDiv.innerHTML = '<div class="error">City not found. Please try a different name.</div>';
                }
            } catch (error) {
                console.error("Error looking up city:", error);
                resultDiv.innerHTML = '<div class="error">Error looking up city. Please check your internet connection or try again.</div>';
            }
        }

        function showError(message) { /* ... no changes ... */
            document.getElementById('results').style.display = 'block';
            document.getElementById('ai-insight').innerHTML = '';
            document.getElementById('position-details').innerHTML = `<div class="error">${message}</div>`;
        }
        
        // ---- ASTRONOMY CALCULATION ENGINE ----
        // ... (The entire astronomy calculation engine from the previous response remains here, unchanged) ...
        function formatDegrees(degrees) {
            degrees = (degrees + 360) % 360; // Normalize to 0-360
            let d = Math.floor(degrees);
            let m = Math.floor(Math.abs((degrees - d) * 60));
            let s = Math.abs(((degrees - d) * 60 - m) * 60).toFixed(2);
            return `${d}° ${m}' ${s}"`;
        }

        function calculatePosition() {
            // 1. Get and Validate Inputs
            if (selectedLocation === 'coordinates') {
                const lat = parseFloat(document.getElementById('latitude').value);
                const lon = parseFloat(document.getElementById('longitude').value);
                if (isNaN(lat) || isNaN(lon)) {
                    showError("Please enter valid latitude and longitude.");
                    return;
                }
                locationData = { latitude: lat, longitude: lon, name: "Custom Coordinates" };
            } else if (selectedLocation === 'city' && !locationData.name) {
                 showError("Please look up a city first or select a different location option.");
                 return;
            }

            if (!selectedPlanet) {
                showError("Please select a planet to calculate.");
                return;
            }

            const dateStr = document.getElementById('date').value;
            const timeStr = document.getElementById('time').value;
            if (!dateStr || !timeStr) {
                showError("Please enter a valid date and time.");
                return;
            }

            const obsDate = new Date(`${dateStr}T${timeStr}Z`); // Treat as UTC
            
            // Update the info overlay with the new time if it's open
             if(document.getElementById('calculator').classList.contains('visible')){
                document.getElementById('overlay-datetime').textContent = obsDate.toUTCString().replace("GMT", "");
                document.getElementById('overlay-location').textContent = locationData.name;
            }

            // 2. Perform Calculations
            const results = getPlanetPosition(selectedPlanet, obsDate, locationData.latitude, locationData.longitude);

            // 3. Display Results
            const resultsDiv = document.getElementById('results');
            const detailsDiv = document.getElementById('position-details');
            const insightDiv = document.getElementById('ai-insight');

            detailsDiv.innerHTML = `
                <div class="result-item">
                    <span class="result-label">Azimuth (Direction)</span>
                    <span class="result-value">${formatDegrees(results.azimuth)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Altitude (Height)</span>
                    <span class="result-value">${formatDegrees(results.altitude)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Right Ascension</span>
                    <span class="result-value">${formatDegrees(results.ra * 15)}</span>
                </div>
                 <div class="result-item">
                    <span class="result-label">Declination</span>
                    <span class="result-value">${formatDegrees(results.dec)}</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Distance from Earth</span>
                    <span class="result-value">${results.distance.toFixed(4)} AU</span>
                </div>
            `;
            
            let azDir;
            if (results.azimuth >= 337.5 || results.azimuth < 22.5) azDir = "North";
            else if (results.azimuth < 67.5) azDir = "Northeast";
            else if (results.azimuth < 112.5) azDir = "East";
            else if (results.azimuth < 157.5) azDir = "Southeast";
            else if (results.azimuth < 202.5) azDir = "South";
            else if (results.azimuth < 247.5) azDir = "Southwest";
            else if (results.azimuth < 292.5) azDir = "West";
            else azDir = "Northwest";

            let insightText;
            if (results.altitude > 5) {
                insightText = `<strong>${selectedPlanet} is currently visible!</strong> Look towards the <strong>${azDir}</strong>, about ${Math.round(results.altitude)} degrees above the horizon.`;
            } else if (results.altitude > -5) {
                 insightText = `<strong>${selectedPlanet} is on the horizon.</strong> It may be difficult to see, but it's located in the <strong>${azDir}</strong> direction.`;
            } else {
                 insightText = `<strong>${selectedPlanet} is currently below the horizon</strong> from your location and is not visible.`;
            }
             insightText += `<br><br>This calculation is for ${obsDate.toUTCString().replace("GMT", "")} from ${locationData.name}.`;


            insightDiv.innerHTML = insightText;
            resultsDiv.style.display = 'block';
            resultsDiv.scrollIntoView({ behavior: 'smooth' });

            // Show distance on galaxy view
            const distDisplay = document.getElementById('distance-display');
            distDisplay.innerHTML = `<strong>${selectedPlanet}</strong> ${results.distance.toFixed(4)} AU from Earth`;
            distDisplay.style.opacity = '1';
        }
        
        const orbitalElements = {
            'Mercury': { a: 0.387098, e: 0.205630, i: 7.00487, L: 252.25084, w: 77.45645, N: 48.33167, ad: 0, ed: 0, id: 0, Ld: 149472.67411, wd: 0.16047, Nd: -0.12534 },
            'Venus': { a: 0.723332, e: 0.006773, i: 3.39471, L: 181.97973, w: 131.53298, N: 76.68069, ad: 0, ed: 0, id: 0, Ld: 58517.81538, wd: 0.00268, Nd: -0.27769 },
            'Earth': { a: 1.000000, e: 0.016710, i: 0.00005, L: 100.46435, w: 102.94719, N: -11.26064, ad: 0, ed: 0, id: 0, Ld: 35999.37285, wd: 0.32327, Nd: -0.23849 },
            'Mars': { a: 1.523662, e: 0.093412, i: 1.85061, L: -4.553432, w: -23.943629, N: 49.57854, ad: 0, ed: 0, id: 0, Ld: 19140.30268, wd: 0.44253, Nd: -0.26853 },
            'Jupiter': { a: 5.203363, e: 0.048392, i: 1.30530, L: 34.40438, w: 14.75385, N: 100.55615, ad: 0, ed: 0, id: 0, Ld: 3034.90565, wd: 0.21253, Nd: 0.20377 },
            'Saturn': { a: 9.537070, e: 0.054150, i: 2.48446, L: 49.94432, w: 92.43194, N: 113.71504, ad: 0, ed: 0, id: 0, Ld: 1222.11379, wd: -0.41897, Nd: -0.28867 },
            'Uranus': { a: 19.19126, e: 0.047167, i: 0.76986, L: 313.23218, w: 170.96424, N: 74.22988, ad: 0, ed: 0, id: 0, Ld: 428.46699, wd: 0.40805, Nd: 0.04240 },
            'Neptune': { a: 30.06896, e: 0.008585, i: 1.76917, L: -55.12003, w: 44.97135, N: 131.72169, ad: 0, ed: 0, id: 0, Ld: 218.48910, wd: -0.00912, Nd: -0.00599 }
        };
        const D2R = Math.PI / 180;
        const R2D = 180 / Math.PI;
        function getPlanetPosition(planetName, date, lat, lon) {
            const jd = (date.getTime() / 86400000) - (date.getTimezoneOffset()/1440) + 2440587.5;
            const d = jd - 2451545.0;
            const helioEarth = calcHeliocentricCoords(orbitalElements.Earth, d);
            const helioPlanet = calcHeliocentricCoords(orbitalElements[planetName], d);
            const geoX = helioPlanet.x - helioEarth.x;
            const geoY = helioPlanet.y - helioEarth.y;
            const geoZ = helioPlanet.z - helioEarth.z;
            let lon_ecl = Math.atan2(geoY, geoX);
            let lat_ecl = Math.atan2(geoZ, Math.sqrt(geoX*geoX + geoY*geoY));
            const T = d / 36525;
            const obl = (23.4392911 - (46.8150 * T - 0.00059 * T*T + 0.001813 * T*T*T) / 3600) * D2R;
            const ra = Math.atan2(Math.sin(lon_ecl)*Math.cos(obl) - Math.tan(lat_ecl)*Math.sin(obl), Math.cos(lon_ecl)) * R2D / 15;
            const dec = Math.asin(Math.sin(lat_ecl)*Math.cos(obl) + Math.cos(lat_ecl)*Math.sin(obl)*Math.sin(lon_ecl)) * R2D;
            const GMST0 = (18.697374558 + 24.06570982441908 * d) % 24;
            const UT = date.getUTCHours() + date.getUTCMinutes()/60 + date.getUTCSeconds()/3600;
            const LST = (GMST0 + UT * 1.002737909 + lon / 15) % 24;
            const HA = (LST - ra) * 15 * D2R;
            const sin_alt = Math.sin(dec * D2R) * Math.sin(lat * D2R) + Math.cos(dec * D2R) * Math.cos(lat * D2R) * Math.cos(HA);
            const altitude = Math.asin(sin_alt) * R2D;
            const cos_az = (Math.sin(dec*D2R) - Math.sin(altitude*D2R)*Math.sin(lat*D2R)) / (Math.cos(altitude*D2R)*Math.cos(lat*D2R));
            let azimuth = Math.acos(cos_az) * R2D;
            if (Math.sin(HA) > 0) azimuth = 360 - azimuth;
            return {
                azimuth: azimuth, altitude: altitude, ra: (ra < 0) ? ra + 24 : ra, dec: dec,
                distance: Math.sqrt(geoX*geoX + geoY*geoY + geoZ*geoZ)
            };
        }
        function calcHeliocentricCoords(p, d) {
            const M = (p.L + p.Ld * d / 36525) % 360;
            const w = p.w + p.wd * d / 36525;
            const N = p.N + p.Nd * d / 36525;
            const i = p.i + p.id * d / 36525;
            const e = p.e + p.ed * d / 36525;
            let E = M + e * R2D * Math.sin(M * D2R);
            for (let i = 0; i < 5; i++) {
                E = E - (E - e * R2D * Math.sin(E * D2R) - M) / (1 - e * Math.cos(E * D2R));
            }
            const x_ecl = p.a * (Math.cos(E * D2R) - e);
            const y_ecl = p.a * Math.sqrt(1 - e*e) * Math.sin(E * D2R);
            const r = Math.sqrt(x_ecl*x_ecl + y_ecl*y_ecl);
            const v = Math.atan2(y_ecl, x_ecl) * R2D;
            const lon_peri = w;
            const xh = r * (Math.cos(N*D2R)*Math.cos((v+lon_peri-N)*D2R) - Math.sin(N*D2R)*Math.sin((v+lon_peri-N)*D2R)*Math.cos(i*D2R));
            const yh = r * (Math.sin(N*D2R)*Math.cos((v+lon_peri-N)*D2R) + Math.cos(N*D2R)*Math.sin((v+lon_peri-N)*D2R)*Math.cos(i*D2R));
            const zh = r * (Math.sin((v+lon_peri-N)*D2R)*Math.sin(i*D2R));
            return {x: xh, y: yh, z: zh};
        }
    </script>
</body>
</html>